@echo off
::  Xylo Ping Reduction Utility  –  FREE VERSION  –  CMD-ONLY
::  Auto-creates a System Restore Point on first run this session
::  ==============================================================
title Xylo Ping Reduction Utility (Free Version)
color 0A
mode con: cols=70 lines=30

:: -----  AUTO RESTORE POINT (once per session)  -----
set "RP_DONE=%temp%\XyloRP_%username%.tmp"
if not exist "%RP_DONE%" (
    echo Creating System Restore Point …
    echo.
    wmic.exe /Namespace:\\root\default Path SystemRestore Call CreateRestorePoint "Xylo Ping Tweaks", 100, 7 >nul 2>&1
    if !errorlevel! equ 0 (
        echo    [OK] Restore Point created.
        type nul > "%RP_DONE%"
    ) else (
        echo    [!] Could not create Restore Point (UAC cancelled or WMIC failed).
        echo        Continuing anyway …
    )
    timeout /t 3 >nul
)

:MENU
cls
echo.
echo    ================================================
echo       Xylo Ping Reduction Utility  (Free Version)
echo    ================================================
echo.
echo    [1]  Prioritise Game Traffic ^(QoS^)
echo    [2]  Disable Windows Bandwidth Limit
echo    [3]  Optimise Packet Handling
echo    [4]  Block Xbox Live / Game-Save Traffic
echo    [5]  Disable Nagle's Algorithm  ^(lower delay^)
echo    [6]  Apply ALL Tweaks
echo    [7]  Exit
echo.
set /P CHOICE= Choose 1-7 : || goto MENU
if "%CHOICE%"=="1" goto QOS
if "%CHOICE%"=="2" goto BANDWIDTH
if "%CHOICE%"=="3" goto PACKET
if "%CHOICE%"=="4" goto BACKGROUND
if "%CHOICE%"=="5" goto NAGLE
if "%CHOICE%"=="6" goto DOALL
if "%CHOICE%"=="7" del "%RP_DONE%" 2>nul & exit /b
goto MENU

:QOS
echo.
echo --- Applying QoS Game Priority ---
netsh int tcp set global autotuninglevel=normal
netsh int tcp set global chimney=enabled
netsh int tcp set global rss=enabled
netsh int tcp set global netdma=enabled
echo    [OK] QoS tweak finished.
pause
goto MENU

:BANDWIDTH
echo.
echo --- Disabling Windows Bandwidth Limit ---
reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows\Psched" /v NonBestEffortLimit /t REG_DWORD /d 0 /f >nul 2>&1
echo    [OK] Bandwidth limit removed.
pause
goto MENU

:PACKET
echo.
echo --- Optimising Packet Handling ---
netsh int ip set global taskoffload=enabled
netsh int tcp set global ecncapability=disabled
netsh int tcp set global timestamps=disabled
echo    [OK] Packet handling optimised.
pause
goto MENU

:BACKGROUND
echo.
echo --- Minimising Background Network Usage ---
netsh advfirewall firewall set allprofiles state on >nul
netsh advfirewall firewall add rule name="Block Xbox Live" dir=out action=block service=XblAuthManager >nul 2>&1
netsh advfirewall firewall add rule name="Block Xbox Game-Save" dir=out action=block service=XblGameSave >nul 2>&1
echo    [OK] Xbox background traffic blocked.
pause
goto MENU

:NAGLE
echo.
echo --- Disabling Nagle's Algorithm ---
for /f "tokens=3*" %%a in ('reg query "HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\Interfaces" /s /f "DhcpIPAddress" 2^>nul ^| findstr "DhcpIPAddress"') do (
   reg add "HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\Interfaces\%%a" /v TcpAckFrequency    /t REG_DWORD /d 1 /f >nul 2>&1
   reg add "HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\Interfaces\%%a" /v TcpDelAckTicks    /t REG_DWORD /d 0 /f >nul 2>&1
   reg add "HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\Interfaces\%%a" /v TcpNoDelay        /t REG_DWORD /d 1 /f >nul 2>&1
)
echo    [OK] Nagle disabled on all active adapters.
pause
goto MENU

:DOALL
echo.
echo --- Applying ALL Tweaks ---
call :QOS >nul 2>&1
call :BANDWIDTH >nul 2>&1
call :PACKET >nul 2>&1
call :BACKGROUND >nul 2>&1
call :NAGLE >nul 2>&1
echo.
echo  ================================================
echo        ALL TWEAKS FINISHED SUCCESSFULLY!
echo  ================================================
pause
goto MENU
